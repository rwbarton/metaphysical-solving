{% extends "puzzles/base_generic.html" %}

{% load static %}

{% block title %}Overview{% endblock %}

{% block content %}

<div class="rounds-container" id="roundsContainer">
    <div class="loading-indicator">
        <i class="ti ti-loader-2 loader-icon"></i>
    </div>
</div>
<div id="last-updated"></div>
<div id="filter-buttons">
    <button onClick="toggleFilterPopup()">
        <i class="ti ti-adjustments-horizontal"></i>
    </button>
</div>
<div id="filter-overlay" class="overlay" onClick="toggleFilterPopup()"></div>
<div id="filter-popup">
    <div class="filter-popup-header"><i class="ti ti-adjustments-horizontal"></i>View Settings</div>
</div>
<script>
    // TODO
    // - View options
    // - Filtering options
    // - Saving the above settings locally
    // - Who's on the puzzle and link to relevant page

    function toggleFilterPopup() {
      const filterPopup = document.getElementById('filter-popup');
      const overlay = document.getElementById('filter-overlay');

      document.body.classList.toggle('overlay-open');
      overlay.classList.toggle('active');
      filterPopup.classList.toggle('active');
      
      const isFilterPopupOpen = filterPopup.classList.contains('active');
    }
    
    // Template function for a puzzle
    function renderPuzzle(puzzle) {
        return `
            <div class="puzzle ${puzzle.unopened ? 'unopened' : ''}">
                <div class="puzzle-top">
                <div class="puzzle-header">
                    <a href="/puzzle/${puzzle.id}" target="mp_${puzzle.id}"><span class="puzzle-title">${puzzle.title}</span></a>
                    <a href="/puzzle/linkout/${puzzle.id}" target="main_${puzzle.id}" class="puzzle-link" target="_blank">
                        <i class="ti ti-external-link"></i>
                    </a>
                </div>
                ${puzzle.status ? `
                    <div class="status-badge">${puzzle.status}</div> `
                    : `<div class="answer-badge"><i class="ti ti-circle-check answer-check"></i>${puzzle.answer}</div>`}
                </div>
                ${puzzle.description ? `<div class="puzzle-description">${puzzle.description}</div>` : ''}
                <div class="puzzle-meta">
                    ${puzzle.solver_count > 0 ? `
                        <span class="solver-count">
                            <i class="ti ti-users"></i>
                            ${puzzle.solver_count}
                        </span>
                    ` : ''}
                    ${puzzle.tags && puzzle.tags.length > 0 ? `
                        <div class="puzzle-tags">
                            ${puzzle.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
                
            </div>
        `;
    }

    // Template function for a round
    function renderRound(round, parentRound = null) {
        const roundTitle = parentRound ? `${parentRound}<i class="ti ti-chevron-right round-chevron"></i>${round.round}` : round.round;
        return `
            <div class="round">
                <div class="round-header">
                    <div class="round-title">${roundTitle}</div>
                    ${round.description ? `<div class="round-description">${round.description}</div>` : ''}
                </div>
                ${round.puzzles ? `
                    <div class="puzzle-list">
                        ${round.puzzles.map(puzzle => renderPuzzle(puzzle)).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }

    // Function to render the dashboard
    function renderDashboard(data) {
        const container = document.getElementById('roundsContainer');
        let html = '';

        // Process parent-child relationships
        data.rounds.forEach(round => {
            if (round.parent_round && round.puzzles) {
                html += renderRound(round, round.parent_round);
            }
            else if (round.puzzles) {
                html += renderRound (round);
            }
        });
        
        container.innerHTML = html;
        document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
    }

      // Function to fetch and update data
      async function fetchAndUpdate() {
          try {
              const response = await fetch("{% url 'puzzles.views.api_overview' %}", {
                method: "POST",
                headers: {
                    "X-CSRFToken": "{{ csrf_token }}",
                }});
              const data = await response.json();
              renderDashboard(data);
          } catch (error) {
              console.error('Error fetching puzzle data:', error);
          }
      }

      // Initial load
      fetchAndUpdate();

      // Update every 60 seconds
      setInterval(fetchAndUpdate, 60000);
  </script>
{% endblock %}
