{% extends "puzzles/base_generic.html" %}

{% load static %}

{% block title %}Unloved Puzzles{% endblock %}

{% block content %}
<div class="unloved-page">
  <h2 class="unloved-page-header">Stalled Puzzles</h2>

  <div class="unloved-filters">
    <label class="filter-checkbox">
      <input type="checkbox" id="show-solved" onchange="handleFilterChange()">
      <span class="checkbox-label">Show solved puzzles</span>
    </label>
  </div>

  <div id="dialog-window">
    <div id="dialog-window-save-progress">
      <div class="loading-placeholder"><i class="ti ti-loader-2 dialog-loading"></i></div>
      Sending, please hold...
    </div>
    <div id="dialog-window-close-button" onClick="hideDialog()">
      <i class="ti ti-x"></i>
    </div>
    <div id="dialog-window-content">
    </div>
  </div>
  <div id="dialog-overlay" onClick="hideDialog()"></div>

  <!-- Table 1: Stalled Puzzles (by Status) -->
  <div class="unloved-section">
    <h3 class="unloved-section-title">Stalled Puzzles (by Status)</h3>
    <div class="unloved-table-container">
      <div id="table1-loading" class="loading-indicator">
        <i class="ti ti-loader-2 loader-icon"></i>
      </div>
      <table class="unloved-table" id="table1">
        <thead>
          <tr>
            <th class="col-history"></th>
            <th class="col-last-viewed sortable" data-sort="last_viewed">
              Last Viewed <i class="ti ti-arrows-sort sort-icon"></i>
            </th>
            <th class="col-puzzle">Puzzle</th>
            <th class="col-priority sortable" data-sort="priority">
              Priority <i class="ti ti-arrows-sort sort-icon"></i>
            </th>
          </tr>
        </thead>
        <tbody id="table1-body">
        </tbody>
      </table>
    </div>
  </div>

  <!-- Table 2: Stalled Puzzles (by Google Sheets Status) -->
  <div class="unloved-section">
    <h3 class="unloved-section-title">Stalled Puzzles (by Google Sheets Status)</h3>
    <div class="unloved-table-container">
      <div id="table2-loading" class="loading-indicator">
        <i class="ti ti-loader-2 loader-icon"></i>
      </div>
      <table class="unloved-table" id="table2">
        <thead>
          <tr>
            <th class="col-history"></th>
            <th class="col-last-viewed sortable" data-sort="last_viewed">
              Last Updated <i class="ti ti-arrows-sort sort-icon"></i>
            </th>
            <th class="col-puzzle">Puzzle</th>
            <th class="col-priority sortable" data-sort="priority">
              Priority <i class="ti ti-arrows-sort sort-icon"></i>
            </th>
          </tr>
        </thead>
        <tbody id="table2-body">
        </tbody>
      </table>
    </div>
  </div>

  <div id="last-updated"></div>
</div>

<script>
  let table1Data = [];
  let table2Data = [];
  let table1SortColumn = null;
  let table1SortDirection = 'asc';
  let table2SortColumn = null;
  let table2SortDirection = 'asc';

  // Show dialog overlay
  function showDialogOverlay(html) {
    document.getElementById("dialog-overlay").style.display = 'block';
    document.getElementById("dialog-window-content").innerHTML = html ? html : "Dialog window content";
    document.getElementById("dialog-window").style.display = "block";
  }

  function hideDialog() {
    document.getElementById("dialog-overlay").style.display = 'none';
    document.getElementById("dialog-window").style.display = 'none';
  }

  async function viewSolvers(puzzle_id) {
    let html = `<div class="loading-placeholder"><i class="ti ti-loader-2 dialog-loading"></i></div>`;
    showDialogOverlay(html);
    try {
      const response = await fetch(`/api_puzzle_history/${puzzle_id}`, {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        }
      });
      const data = await response.json();
      html = `
        ${data.current_viewers.length > 0 ?
          `<div class="dialog-row">
            <header class="dialog-section-header">
            <i class="ti ti-binoculars"></i> Currently viewing
            </header>
           ${data.current_viewers.map(viewer => `
                <a href="/zulip_dm/${viewer.id}/" target="_blank"><div class="viewer">
                  <div class="viewer-pic"><img src="/profile_photo/${viewer.id}" class="viewer-pic-image"/></div>
                  <div class="viewer-info">
                    <div class="viewer-name">${viewer.first_name} ${viewer.last_name}</div>
                    <div class="viewer-location">${viewer.location}</div>
                  </div>
                </div></a>`).join('')}
          </div>` : ''}
        ${data.prior_viewers.length > 0 ?
          `<div class="dialog-row">
            <header class="dialog-section-header">
            <i class="ti ti-history"></i> Viewed in the past
            </header>
           ${data.prior_viewers.map(viewer => `
                <a href="/zulip_dm/${viewer.id}/" target="_blank"><div class="viewer">
                  <div class="viewer-pic"><img src="/profile_photo/${viewer.id}" class="viewer-pic-image"/></div>
                  <div class="viewer-info">
                    <div class="viewer-name">${viewer.first_name} ${viewer.last_name}</div>
                    <div class="viewer-location">${viewer.hours} ${viewer.hours == 1 ? 'hour' : 'hours'}, ${viewer.location}</div>
                  </div>
                </div></a>`).join('')}
        </div>` :
          `<div class="dialog-row">
            <header class="dialog-section-header">
            <i class="ti ti-history"></i> Viewed in the past
            </header></div>`}
      `;
      showDialogOverlay(html);
    } catch (error) {
      console.error('Error fetching puzzle data:', error);
    }
  }

  function renderPuzzleRow(puzzle) {
    const priorityCss = puzzle.puzzle.priority_css || 'normal';
    const freshnessClass = `unloved-${puzzle.freshness}`;
    const timeClass = puzzle.total_time ? `unloved-${puzzle.total_time.slice(-1)}` : '';

    return `
      <tr>
        <td class="col-history ${timeClass}">
          ${puzzle.total_time ? `
            <button class="unloved-history" title="Show solver history" onClick="viewSolvers(${puzzle.puzzle.id})">
              <div><i class="ti ti-history"></i></div>
              <div>${puzzle.total_time}</div>
            </button>
          ` : ''}
        </td>
        <td class="col-last-viewed ${freshnessClass}" data-sort-value="${puzzle.last_update || ''}">
          <div class="last-viewed-time">${puzzle.human}</div>
          ${puzzle.updating_username ? `
            <div class="viewer-name">
              <a target="_blank" href="/zulip_dm/${puzzle.updating_userid}/">${puzzle.updating_username}</a>
            </div>
          ` : ''}
        </td>
        <td class="col-puzzle">
          <div class="puzzle-header">
            <a href="/puzzle/${puzzle.puzzle.id}">
              <span class="puzzle-title">
                ${puzzle.puzzle.round ? `${puzzle.puzzle.round} > ` : ''}${puzzle.puzzle.title}
              </span>
            </a>
            <a href="/puzzle/linkout/${puzzle.puzzle.id}" target="_blank" class="puzzle-link">
              <i class="ti ti-external-link"></i>
            </a>
          </div>
          ${puzzle.puzzle.description ? `<div class="puzzle-description">${puzzle.puzzle.description}</div>` : ''}
        </td>
        <td class="col-priority" data-sort-value="${puzzle.puzzle.priority}">
          <div class="priority-info">
            <div class="priority-badge ${priorityCss}-priority">${puzzle.puzzle.priority}</div>
            <div class="status-text">${puzzle.puzzle.status}</div>
          </div>
        </td>
      </tr>
    `;
  }

  function sortTable(tableId, data, column, direction) {
    const sortedData = [...data].sort((a, b) => {
      let aVal, bVal;

      if (column === 'last_viewed') {
        aVal = a.last_update || '';
        bVal = b.last_update || '';
      } else if (column === 'priority') {
        // Define priority order: asap! > high > normal > low
        const priorityOrder = { 'asap!': 4, 'high': 3, 'normal': 2, 'low': 1 };
        aVal = priorityOrder[a.puzzle.priority.toLowerCase()] || 0;
        bVal = priorityOrder[b.puzzle.priority.toLowerCase()] || 0;
      }

      if (direction === 'asc') {
        return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
      } else {
        return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
      }
    });

    return sortedData;
  }

  function renderTable(tableId, data, sortColumn, sortDirection) {
    const tbody = document.getElementById(`${tableId}-body`);
    const showSolved = document.getElementById('show-solved').checked;

    // Filter out solved puzzles if checkbox is unchecked
    let filteredData = data;
    if (!showSolved) {
      filteredData = data.filter(puzzle => puzzle.puzzle.status.toLowerCase() !== 'solved!');
    }

    const sortedData = sortColumn ? sortTable(tableId, filteredData, sortColumn, sortDirection) : filteredData;

    tbody.innerHTML = sortedData.map(puzzle => renderPuzzleRow(puzzle)).join('');

    // Update sort icons
    const table = document.getElementById(tableId);
    table.querySelectorAll('.sortable').forEach(th => {
      const icon = th.querySelector('.sort-icon');
      if (th.dataset.sort === sortColumn) {
        icon.className = sortDirection === 'asc' ?
          'ti ti-sort-ascending sort-icon active' :
          'ti ti-sort-descending sort-icon active';
      } else {
        icon.className = 'ti ti-arrows-sort sort-icon';
      }
    });
  }

  function handleFilterChange() {
    renderTable('table1', table1Data, table1SortColumn, table1SortDirection);
    renderTable('table2', table2Data, table2SortColumn, table2SortDirection);
  }

  async function fetchTable1() {
    try {
      document.getElementById('table1-loading').style.display = 'flex';
      const response = await fetch("{% url 'puzzles.views.api_unloved' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        }
      });
      const data = await response.json();
      table1Data = data.puzzles;
      renderTable('table1', table1Data, table1SortColumn, table1SortDirection);
      document.getElementById('table1-loading').style.display = 'none';
    } catch (error) {
      console.error('Error fetching table 1 data:', error);
      document.getElementById('table1-loading').style.display = 'none';
    }
  }

  async function fetchTable2() {
    try {
      document.getElementById('table2-loading').style.display = 'flex';
      const response = await fetch("{% url 'puzzles.views.api_unloved_by_spreadsheet' %}", {
        method: "POST",
        headers: {
          "X-CSRFToken": "{{ csrf_token }}",
        }
      });
      const data = await response.json();
      table2Data = data.puzzles;
      renderTable('table2', table2Data, table2SortColumn, table2SortDirection);
      document.getElementById('table2-loading').style.display = 'none';
    } catch (error) {
      console.error('Error fetching table 2 data:', error);
      document.getElementById('table2-loading').style.display = 'none';
    }
  }

  async function fetchAndUpdate() {
    await Promise.all([fetchTable1(), fetchTable2()]);
    document.getElementById('last-updated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
  }

  // Setup sort handlers
  function setupSortHandlers() {
    document.querySelectorAll('#table1 .sortable').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.dataset.sort;
        if (table1SortColumn === column) {
          table1SortDirection = table1SortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          table1SortColumn = column;
          table1SortDirection = 'asc';
        }
        renderTable('table1', table1Data, table1SortColumn, table1SortDirection);
      });
    });

    document.querySelectorAll('#table2 .sortable').forEach(th => {
      th.addEventListener('click', () => {
        const column = th.dataset.sort;
        if (table2SortColumn === column) {
          table2SortDirection = table2SortDirection === 'asc' ? 'desc' : 'asc';
        } else {
          table2SortColumn = column;
          table2SortDirection = 'asc';
        }
        renderTable('table2', table2Data, table2SortColumn, table2SortDirection);
      });
    });
  }

  // Initial load
  setupSortHandlers();
  fetchAndUpdate();

  // Update every 60 seconds
  setInterval(fetchAndUpdate, 60000);
</script>
{% endblock %}
